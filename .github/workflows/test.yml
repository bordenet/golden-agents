name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # BATS tests for generate-agents.sh on Linux and macOS
  bash-tests:
    name: BATS (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install BATS (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core
          cd /tmp/bats-core && sudo ./install.sh /usr/local

      - name: Install BATS (macOS)
        if: runner.os == 'macOS'
        run: brew install bats-core

      - name: Install BATS helper libraries
        run: |
          mkdir -p test/test_helper
          git clone --depth 1 https://github.com/bats-core/bats-support.git test/test_helper/bats-support
          git clone --depth 1 https://github.com/bats-core/bats-assert.git test/test_helper/bats-assert

      - name: Run BATS tests
        run: bats test/*.bats

      - name: Test summary
        if: always()
        run: |
          echo "## BATS Test Results (${{ matrix.os }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Tests |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Upgrade Safety (P0) | 10 |" >> $GITHUB_STEP_SUMMARY
          echo "| Argument Parsing (P1) | 10 |" >> $GITHUB_STEP_SUMMARY
          echo "| Auto-Detection (P1) | 7 |" >> $GITHUB_STEP_SUMMARY
          echo "| Generation (P2) | 10 |" >> $GITHUB_STEP_SUMMARY
          echo "| Templates (P3) | 8 |" >> $GITHUB_STEP_SUMMARY
          echo "| Sync (P3) | 2 |" >> $GITHUB_STEP_SUMMARY
          echo "| Edge Cases | 6 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total: 53 BATS tests**" >> $GITHUB_STEP_SUMMARY

  # BATS tests on Windows via Git Bash
  # Windows support is secondary - failures here don't block the build
  windows-bash-tests:
    name: BATS (Windows Git Bash)
    runs-on: windows-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Install BATS in Git Bash
        shell: bash
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats
          cd /tmp/bats && ./install.sh "$HOME/bats"
          echo "$HOME/bats/bin" >> $GITHUB_PATH

      - name: Install BATS helper libraries
        shell: bash
        run: |
          mkdir -p test/test_helper
          git clone --depth 1 https://github.com/bats-core/bats-support.git test/test_helper/bats-support
          git clone --depth 1 https://github.com/bats-core/bats-assert.git test/test_helper/bats-assert

      - name: Run BATS tests
        shell: bash
        run: |
          export PATH="$HOME/bats/bin:$PATH"
          bats test/*.bats

  # PowerShell wrapper tests using Pester (Linux/macOS - required)
  powershell-tests:
    name: Pester (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -Force -SkipPublisherCheck -MinimumVersion 5.0

      - name: Run Pester tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = "test/*.Tests.ps1"
          $config.Output.Verbosity = "Detailed"
          $config.Run.Exit = $true
          Invoke-Pester -Configuration $config

  # PowerShell wrapper tests on Windows (optional - doesn't block build)
  powershell-tests-windows:
    name: Pester (windows-latest)
    runs-on: windows-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -Force -SkipPublisherCheck -MinimumVersion 5.0

      - name: Run Pester tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = "test/*.Tests.ps1"
          $config.Output.Verbosity = "Detailed"
          $config.Run.Exit = $true
          Invoke-Pester -Configuration $config

  # ShellCheck linting
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck
        run: shellcheck generate-agents.sh

      - name: ShellCheck summary
        if: always()
        run: |
          echo "## ShellCheck Results" >> $GITHUB_STEP_SUMMARY
          shellcheck generate-agents.sh --format=gcc >> $GITHUB_STEP_SUMMARY 2>&1 || true

  # Code coverage with kcov
  coverage:
    name: Coverage
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install BATS
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core
          cd /tmp/bats-core && sudo ./install.sh /usr/local

      - name: Install BATS helper libraries
        run: |
          mkdir -p test/test_helper
          git clone --depth 1 https://github.com/bats-core/bats-support.git test/test_helper/bats-support
          git clone --depth 1 https://github.com/bats-core/bats-assert.git test/test_helper/bats-assert

      - name: Install kcov
        run: |
          # Install kcov build dependencies
          sudo apt-get update
          sudo apt-get install -y cmake binutils-dev libcurl4-openssl-dev zlib1g-dev libdw-dev libiberty-dev
          # Build kcov from source
          git clone --depth 1 --branch v42 https://github.com/SimonKagstrom/kcov.git /tmp/kcov
          cd /tmp/kcov
          mkdir build && cd build
          cmake ..
          make -j$(nproc)
          sudo make install
          kcov --version

      - name: Run BATS tests with coverage
        run: |
          mkdir -p coverage
          kcov --include-path=. --exclude-path=test,coverage coverage bats test/*.bats

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          directory: ./coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Coverage summary
        if: always()
        run: |
          echo "## Code Coverage" >> $GITHUB_STEP_SUMMARY
          if [[ -f coverage/bats/coverage.json ]]; then
            PERCENT=$(jq -r '.percent_covered' coverage/bats/coverage.json 2>/dev/null || echo "N/A")
            echo "Coverage: ${PERCENT}%" >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi
