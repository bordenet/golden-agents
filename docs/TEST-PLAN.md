# generate-agents.sh Test Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Comprehensive test coverage for generate-agents.sh to prevent regressions and ensure upgrade safety

**Architecture:** BATS (Bash Automated Testing System) with isolated temp directories per test, setup/teardown fixtures, and helper functions for common assertions

**Tech Stack:** BATS-core 1.8+, bats-assert, bats-support

---

## 1. Test Infrastructure

### 1.1 Directory Structure

```
golden-agents/
├── test/
│   ├── setup_suite.bash      # Suite-level setup (install BATS helpers)
│   ├── test_helper.bash      # Shared helper functions
│   ├── args.bats             # Argument parsing tests
│   ├── generate.bats         # New file generation tests
│   ├── upgrade.bats          # Upgrade safety tests (CRITICAL)
│   ├── autodetect.bats       # Auto-detection tests
│   └── templates.bats        # Template file tests
└── docs/
    └── TEST-PLAN.md          # This file
```

### 1.2 Test Helper Functions (`test_helper.bash`)

```bash
# Create a minimal valid Agents.md with markers
create_agents_with_markers() {
    local path="$1"
    local lang="${2:-go}"
    cat > "$path/Agents.md" << EOF
# AI Agent Guidelines - TestProject

> **Generated by**: [golden-agents](https://github.com/bordenet/golden-agents) v1.2.0 (compact)
> **Languages**: $lang
> **Type**: cli-tools

<!-- GOLDEN:framework:start -->
## Framework content here
<!-- GOLDEN:framework:end -->

## Project-Specific Rules

### My Custom Rule
This should be preserved.
EOF
}

# Create Agents.md WITHOUT markers (pre-v1.2.0 style)
create_agents_without_markers() {
    local path="$1"
    cat > "$path/Agents.md" << EOF
# AI Agent Guidelines - TestProject

## Some guidance
This file has no markers.
EOF
}

# Assert file contains string
assert_file_contains() {
    local file="$1"
    local pattern="$2"
    grep -q "$pattern" "$file" || fail "File $file does not contain: $pattern"
}

# Assert file does NOT contain string
assert_file_not_contains() {
    local file="$1"
    local pattern="$2"
    ! grep -q "$pattern" "$file" || fail "File $file should not contain: $pattern"
}
```

### 1.3 BATS Installation (CI)

```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install BATS
        run: |
          git clone https://github.com/bats-core/bats-core.git
          cd bats-core && sudo ./install.sh /usr/local
          git clone https://github.com/bats-core/bats-support.git test/test_helper/bats-support
          git clone https://github.com/bats-core/bats-assert.git test/test_helper/bats-assert
      - name: Run tests
        run: bats test/
```

---

## 2. Test Categories

### 2.1 Argument Parsing Tests (`args.bats`)

| # | Test Case | Command | Expected |
|---|-----------|---------|----------|
| 1 | --help shows usage | `run ./generate-agents.sh --help` | status=0, output contains "SYNOPSIS" |
| 2 | -h shows usage | `run ./generate-agents.sh -h` | status=0, output contains "SYNOPSIS" |
| 3 | --version shows version | `run ./generate-agents.sh --version` | status=0, output contains "v1.2.1" |
| 4 | -v shows version | `run ./generate-agents.sh -v` | status=0, output contains "v1.2.1" |
| 5 | Unknown flag fails | `run ./generate-agents.sh --invalid` | status=1, output contains "Unknown option" |
| 6 | Missing --language fails | `run ./generate-agents.sh --path=/tmp` | status=1, output contains "--language is required" |
| 7 | --apply without --upgrade fails | `run ./generate-agents.sh --apply --path=/tmp` | status=1, output contains "--apply requires --upgrade" |
| 8 | Multiple languages accepted | `run ./generate-agents.sh --language=go,python --dry-run` | status=0 |
| 9 | --compact flag accepted | `run ./generate-agents.sh --language=go --compact --dry-run` | status=0 |
| 10 | --dry-run shows output | `run ./generate-agents.sh --language=go --dry-run` | status=0, output contains "DRY RUN" |

### 2.2 New File Generation Tests (`generate.bats`)

| # | Test Case | Setup | Expected |
|---|-----------|-------|----------|
| 1 | Compact mode generates ~130 lines | `--language=go --compact` | Lines between 100-150, contains markers |
| 2 | Full mode generates ~800 lines | `--language=go` | Lines between 700-900, contains markers |
| 3 | Output contains start marker | Any generation | File contains `<!-- GOLDEN:framework:start -->` |
| 4 | Output contains end marker | Any generation | File contains `<!-- GOLDEN:framework:end -->` |
| 5 | Output contains language header | `--language=python` | Header contains `> **Languages**: python` |
| 6 | Output contains type header | `--type=cli-tools` | Header contains `> **Type**: cli-tools` |
| 7 | Creates output directory if missing | `--path=/tmp/new-dir` | Directory created, file exists |
| 8 | Project name from directory | `--path=/tmp/my-project` | Header contains `# AI Agent Guidelines - my-project` |
| 9 | Custom project name | `--name=CustomName` | Header contains `# AI Agent Guidelines - CustomName` |
| 10 | Multiple languages in header | `--language=go,python` | Header contains `> **Languages**: go,python` |

### 2.3 Upgrade Safety Tests (`upgrade.bats`) — CRITICAL

| # | Test Case | Setup | Expected |
|---|-----------|-------|----------|
| 1 | Upgrade on non-existent file fails | No file | status=1, "No Agents.md found" |
| 2 | Upgrade on file WITHOUT markers REFUSES | `create_agents_without_markers` | status=1, "lacks framework markers", "REFUSING TO MODIFY" |
| 3 | Upgrade dry-run shows diff | `create_agents_with_markers` | status=0, output contains "UPGRADE PREVIEW", "No changes made" |
| 4 | Upgrade dry-run writes nothing | `create_agents_with_markers` | File unchanged after dry-run |
| 5 | Upgrade --apply creates backup | `create_agents_with_markers` | `.backup` file exists |
| 6 | Upgrade --apply modifies original | `create_agents_with_markers` + `--apply` | Original file updated |
| 7 | Project-specific content preserved | Add custom content after end marker | Custom content still present after upgrade |
| 8 | Content before start marker preserved | Add custom header content | Header content preserved after upgrade |
| 9 | Framework content replaced | Modify framework section | Framework content updated to new version |
| 10 | Backup contains original content | Compare backup to pre-upgrade state | Backup matches original exactly |

### 2.4 Auto-Detection Tests (`autodetect.bats`)

| # | Test Case | Setup | Expected |
|---|-----------|-------|----------|
| 1 | Language auto-detected from existing | File with `> **Languages**: python` | Uses python without `--language` flag |
| 2 | Type auto-detected from existing | File with `> **Type**: web-apps` | Uses web-apps without `--type` flag |
| 3 | Compact mode auto-detected | File header contains `(compact)` | Upgrade uses compact mode |
| 4 | Full mode auto-detected | File header lacks `(compact)` | Upgrade uses full mode |
| 5 | Flag overrides auto-detect language | `--language=go` on python file | Uses go, not python |
| 6 | Flag overrides auto-detect type | `--type=cli-tools` on web-apps file | Uses cli-tools |
| 7 | Missing language in file + no flag fails | File without language header | status=1, "Cannot determine languages" |

### 2.5 Template Tests (`templates.bats`)

| # | Test Case | Check | Expected |
|---|-----------|-------|----------|
| 1 | All core templates exist | `test -f templates/core/*.md` | All files present |
| 2 | All language templates exist | `test -f templates/languages/*.md` | go, python, javascript, shell, dart-flutter |
| 3 | All project-type templates exist | `test -f templates/project-types/*.md` | genesis-tools, cli-tools, web-apps, mobile-apps |
| 4 | All workflow templates exist | `test -f templates/workflows/*.md` | All files present |
| 5 | Full mode includes core templates | Generate full, check content | Contains superpowers, communication content |
| 6 | Full mode includes language template | `--language=go` full mode | Contains Go-specific content |
| 7 | Full mode includes type template | `--type=cli-tools` full mode | Contains CLI-specific content |
| 8 | Missing template produces warning | `--type=nonexistent` | stderr contains "Warning: No template" |

### 2.6 Sync Tests (`sync.bats`)

| # | Test Case | Setup | Expected |
|---|-----------|-------|----------|
| 1 | Sync in git repo succeeds | In git directory | status=0, "Templates updated" |
| 2 | Sync in non-git directory fails | Remove .git | status=1, "Not a git repo" |

---

## 3. Test Priority Matrix

| Priority | Category | Rationale |
|----------|----------|-----------|
| **P0 - Critical** | Upgrade Safety (2.3) | Data loss prevention is paramount |
| **P1 - High** | Argument Parsing (2.1) | User-facing errors, first line of defense |
| **P1 - High** | Auto-Detection (2.4) | Upgrade depends on correct detection |
| **P2 - Medium** | New File Generation (2.2) | Core functionality, well-tested manually |
| **P3 - Low** | Template Tests (2.5) | Structural validation, less likely to regress |
| **P3 - Low** | Sync Tests (2.6) | Simple functionality, minimal code paths |

---

## 4. Implementation Order

1. **Setup infrastructure** — `test_helper.bash`, `setup_suite.bash`
2. **P0: upgrade.bats** — Upgrade safety tests (10 tests)
3. **P1: args.bats** — Argument parsing tests (10 tests)
4. **P1: autodetect.bats** — Auto-detection tests (7 tests)
5. **P2: generate.bats** — Generation tests (10 tests)
6. **P3: templates.bats** — Template tests (8 tests)
7. **P3: sync.bats** — Sync tests (2 tests)

**Total: 47 test cases**

---

## 5. Running Tests

### Local (macOS/Linux)

```bash
# Install BATS (Homebrew)
brew install bats-core

# Clone helper libraries
git clone https://github.com/bats-core/bats-support.git test/test_helper/bats-support
git clone https://github.com/bats-core/bats-assert.git test/test_helper/bats-assert

# Run all tests
bats test/

# Run specific test file
bats test/upgrade.bats

# Run with verbose output
bats --verbose-run test/
```

### CI (GitHub Actions)

See section 1.3 for workflow configuration.

---

## 6. Success Criteria

- [ ] All 47 tests pass
- [ ] No test takes longer than 5 seconds
- [ ] Upgrade safety tests cover all documented safety guarantees
- [ ] CI runs on every push and PR
- [ ] Test coverage documented in README badge

