# generate-agents.sh Test Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Comprehensive test coverage for generate-agents.sh to prevent regressions and ensure upgrade safety

**Architecture:** BATS (Bash Automated Testing System) with isolated temp directories per test, setup/teardown fixtures, and helper functions for common assertions

**Tech Stack:** BATS-core 1.8+, bats-assert, bats-support

---

## 1. Test Infrastructure

### 1.1 Directory Structure

```
golden-agents/
├── test/
│   ├── test_helper.bash      # Shared helper functions
│   ├── args.bats             # Argument parsing tests
│   ├── generate.bats         # New file generation tests
│   ├── upgrade.bats          # Upgrade safety tests (CRITICAL)
│   ├── autodetect.bats       # Auto-detection tests
│   ├── templates.bats        # Template file tests
│   ├── migrate.bats          # Migration workflow tests
│   ├── adopt.bats            # Adoption workflow tests
│   ├── dedupe.bats           # Deduplication workflow tests
│   ├── sync.bats             # Template sync tests
│   ├── edge-cases.bats       # Boundary condition tests
│   └── generate-agents.Tests.ps1  # PowerShell wrapper tests
└── docs/
    └── TEST-PLAN.md          # This file
```

### 1.2 Test Helper Functions (`test_helper.bash`)

```bash
# Create a minimal valid Agents.md with markers
create_agents_with_markers() {
    local path="$1"
    local lang="${2:-go}"
    cat > "$path/Agents.md" << EOF
# AI Agent Guidelines - TestProject

> **Generated by**: [golden-agents](https://github.com/bordenet/golden-agents) v1.2.0 (compact)
> **Languages**: $lang
> **Type**: cli-tools

<!-- GOLDEN:framework:start -->
## Framework content here
<!-- GOLDEN:framework:end -->

## Project-Specific Rules

### My Custom Rule
This should be preserved.
EOF
}

# Create Agents.md WITHOUT markers (pre-v1.2.0 style)
create_agents_without_markers() {
    local path="$1"
    cat > "$path/Agents.md" << EOF
# AI Agent Guidelines - TestProject

## Some guidance
This file has no markers.
EOF
}

# Assert file contains string
assert_file_contains() {
    local file="$1"
    local pattern="$2"
    grep -q "$pattern" "$file" || fail "File $file does not contain: $pattern"
}

# Assert file does NOT contain string
assert_file_not_contains() {
    local file="$1"
    local pattern="$2"
    ! grep -q "$pattern" "$file" || fail "File $file should not contain: $pattern"
}
```

### 1.3 BATS Installation (CI)

```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install BATS
        run: |
          git clone https://github.com/bats-core/bats-core.git
          cd bats-core && sudo ./install.sh /usr/local
          git clone https://github.com/bats-core/bats-support.git test/test_helper/bats-support
          git clone https://github.com/bats-core/bats-assert.git test/test_helper/bats-assert
      - name: Run tests
        run: bats test/
```

---

## 2. Test Categories

### 2.1 Argument Parsing Tests (`args.bats`)

| # | Test Case | Command | Expected |
|---|-----------|---------|----------|
| 1 | --help shows usage | `run ./generate-agents.sh --help` | status=0, output contains "SYNOPSIS" |
| 2 | -h shows usage | `run ./generate-agents.sh -h` | status=0, output contains "SYNOPSIS" |
| 3 | --version shows version | `run ./generate-agents.sh --version` | status=0, output contains "v1.2.1" |
| 4 | -v shows version | `run ./generate-agents.sh -v` | status=0, output contains "v1.2.1" |
| 5 | Unknown flag fails | `run ./generate-agents.sh --invalid` | status=1, output contains "Unknown option" |
| 6 | Missing --language fails | `run ./generate-agents.sh --path=/tmp` | status=1, output contains "--language is required" |
| 7 | --apply without --upgrade fails | `run ./generate-agents.sh --apply --path=/tmp` | status=1, output contains "--apply requires --upgrade" |
| 8 | Multiple languages accepted | `run ./generate-agents.sh --language=go,python --dry-run` | status=0 |
| 9 | --compact flag accepted | `run ./generate-agents.sh --language=go --compact --dry-run` | status=0 |
| 10 | --dry-run shows output | `run ./generate-agents.sh --language=go --dry-run` | status=0, output contains "DRY RUN" |

### 2.2 New File Generation Tests (`generate.bats`)

| # | Test Case | Setup | Expected |
|---|-----------|-------|----------|
| 1 | Default (progressive) generates ~60 lines | `--language=go` | Lines between 50-80, contains markers |
| 2 | Compact mode generates ~130 lines | `--language=go --compact` | Lines between 100-150, contains markers |
| 3 | Full mode (deprecated) shows warning | `--language=go --full` | stderr contains "DEPRECATED" |
| 4 | Output contains start marker | Any generation | File contains `<!-- GOLDEN:framework:start -->` |
| 5 | Output contains end marker | Any generation | File contains `<!-- GOLDEN:framework:end -->` |
| 6 | Output contains language header | `--language=python` | Header contains `> **Languages**: python` |
| 7 | Output contains type header | `--type=cli-tools` | Header contains `> **Type**: cli-tools` |
| 8 | Creates output directory if missing | `--path=/tmp/new-dir` | Directory created, file exists |
| 9 | Project name from directory | `--path=/tmp/my-project` | Header contains `# AI Agent Guidelines - my-project` |
| 10 | Multiple languages in header | `--language=go,python` | Header contains `> **Languages**: go,python` |
| 11 | Progressive mode includes load instructions | Default mode | Contains `$HOME/.golden-agents/templates/` |

### 2.3 Upgrade Safety Tests (`upgrade.bats`) — CRITICAL

| # | Test Case | Setup | Expected |
|---|-----------|-------|----------|
| 1 | Upgrade on non-existent file fails | No file | status=1, "No Agents.md found" |
| 2 | Upgrade on file WITHOUT markers REFUSES | `create_agents_without_markers` | status=1, "lacks framework markers", "REFUSING TO MODIFY" |
| 3 | Upgrade dry-run shows diff | `create_agents_with_markers` | status=0, output contains "UPGRADE PREVIEW", "No changes made" |
| 4 | Upgrade dry-run writes nothing | `create_agents_with_markers` | File unchanged after dry-run |
| 5 | Upgrade --apply creates backup | `create_agents_with_markers` | `.backup` file exists |
| 6 | Upgrade --apply modifies original | `create_agents_with_markers` + `--apply` | Original file updated |
| 7 | Project-specific content preserved | Add custom content after end marker | Custom content still present after upgrade |
| 8 | Content before start marker preserved | Add custom header content | Header content preserved after upgrade |
| 9 | Framework content replaced | Modify framework section | Framework content updated to new version |
| 10 | Backup contains original content | Compare backup to pre-upgrade state | Backup matches original exactly |

### 2.4 Auto-Detection Tests (`autodetect.bats`)

| # | Test Case | Setup | Expected |
|---|-----------|-------|----------|
| 1 | Language auto-detected from existing | File with `> **Languages**: python` | Uses python without `--language` flag |
| 2 | Type auto-detected from existing | File with `> **Type**: web-apps` | Uses web-apps without `--type` flag |
| 3 | Compact mode auto-detected | File header contains `(compact)` | Upgrade uses compact mode |
| 4 | Progressive mode auto-detected | File header contains `(progressive)` | Upgrade uses progressive mode |
| 5 | Legacy full mode auto-converts | File header lacks mode indicator | Upgrade converts to progressive |
| 6 | Flag overrides auto-detect language | `--language=go` on python file | Uses go, not python |
| 7 | Flag overrides auto-detect type | `--type=cli-tools` on web-apps file | Uses cli-tools |
| 8 | Missing language in file + no flag fails | File without language header | status=1, "Cannot determine languages" |

### 2.5 Template Tests (`templates.bats`)

| # | Test Case | Check | Expected |
|---|-----------|-------|----------|
| 1 | All core templates exist | `test -f templates/core/*.md` | All files present |
| 2 | All language templates exist | `test -f templates/languages/*.md` | go, python, javascript, shell, dart-flutter |
| 3 | All project-type templates exist | `test -f templates/project-types/*.md` | genesis-tools, cli-tools, web-apps, mobile-apps |
| 4 | All workflow templates exist | `test -f templates/workflows/*.md` | All files present |
| 5 | Full mode includes core templates | Generate full, check content | Contains superpowers, communication content |
| 6 | Full mode includes language template | `--language=go` full mode | Contains Go-specific content |
| 7 | Full mode includes type template | `--type=cli-tools` full mode | Contains CLI-specific content |
| 8 | Missing template produces warning | `--type=nonexistent` | stderr contains "Warning: No template" |

### 2.6 Migration Tests (`migrate.bats`)

| # | Test Case | Setup | Expected |
|---|-----------|-------|----------|
| 1 | --migrate bypasses existing content block | Existing CLAUDE.md | status=0, generates Agents.md |
| 2 | --migrate creates MIGRATION-PROMPT.md | Existing CLAUDE.md | File created with instructions |
| 3 | MIGRATION-PROMPT.md contains existing content | Existing CLAUDE.md | Prompt includes original content |
| 4 | MIGRATION-PROMPT.md has deletion note | Any migration | Contains "DELETE THIS FILE" |
| 5 | .gitignore includes MIGRATION-PROMPT.md | After migration | Entry added to .gitignore |
| 6 | --migrate with no existing content skips prompt | Empty directory | No MIGRATION-PROMPT.md created |
| 7 | MIGRATION-PROMPT.md shows source line count | Existing CLAUDE.md | Contains "Original size: X lines" |
| 8 | MIGRATION-PROMPT.md includes 10-word test | Any migration | Contains "10-word test" |
| 9 | MIGRATION-PROMPT.md includes target sizes | Any migration | Contains target size table |
| 10 | STDOUT shows source file metrics | Existing CLAUDE.md | Shows "Source file: X (Y lines)" |

### 2.7 Adoption Tests (`adopt.bats`)

| # | Test Case | Setup | Expected |
|---|-----------|-------|----------|
| 1 | --adopt requires existing Agents.md | No file | status=1, "No Agents.md found" |
| 2 | --adopt requires --language | Existing file | status=1, "--adopt requires --language" |
| 3 | --adopt refuses file WITH markers | File with markers | status=1, "already has framework markers" |
| 4 | --adopt creates backup | Existing file | Agents.md.original created |
| 5 | --adopt creates ADOPT-PROMPT.md | Existing file | Prompt file created |
| 6 | --adopt appends original content | Existing file | "Preserved Project Content" section |
| 7 | --adopt adds files to .gitignore | Existing file | ADOPT-PROMPT.md and .original in .gitignore |
| 8 | ADOPT-PROMPT.md has deduplication rules | Any adoption | Contains "10-word test" |

### 2.8 Deduplication Tests (`dedupe.bats`)

| # | Test Case | Setup | Expected |
|---|-----------|-------|----------|
| 1 | --dedupe requires existing Agents.md | No file | status=1, "No Agents.md found" |
| 2 | --dedupe requires markers | File without markers | status=1, "does not have framework markers" |
| 3 | --dedupe skips if <100 lines | Small project section | status=0, "already within target" |
| 4 | --dedupe creates ADOPT-PROMPT.md | Bloated file | Prompt file created |
| 5 | --dedupe shows line counts | Bloated file | Shows total, framework, project lines |
| 6 | --dedupe does NOT modify Agents.md | Any file | Original unchanged |

### 2.9 Sync Tests (`sync.bats`)

| # | Test Case | Setup | Expected |
|---|-----------|-------|----------|
| 1 | Sync in git repo succeeds | In git directory | status=0, "Templates updated" |
| 2 | Sync in non-git directory fails | Remove .git | status=1, "Not a git repo" |

### 2.10 Edge Case Tests (`edge-cases.bats`)

| # | Test Case | Setup | Expected |
|---|-----------|-------|----------|
| 1 | Unicode in project name | Path with unicode chars | status=0, file created |
| 2 | Spaces in path | Path with spaces | status=0, file created |
| 3 | Special characters in name | Dashes, underscores, dots | status=0, name in output |
| 4 | Empty --name uses directory | `--name=""` | Directory name used |
| 5 | Long project name | 50+ char name | status=0, name in output |
| 6 | Read-only directory fails | `chmod a-w` | status≠0, clear error |

### 2.11 PowerShell Wrapper Tests (`generate-agents.Tests.ps1`)

| # | Test Case | Command | Expected |
|---|-----------|---------|----------|
| 1 | Script file exists | Test-Path | File present |
| 2 | Bash script exists | Test-Path | File present |
| 3 | --help shows usage | `.\generate-agents.ps1 --help` | status=0, SYNOPSIS |
| 4 | --version shows version | `.\generate-agents.ps1 --version` | status=0, v1.x |
| 5 | -h equivalent to --help | `.\generate-agents.ps1 -h` | status=0, SYNOPSIS |
| 6 | -v equivalent to --version | `.\generate-agents.ps1 -v` | status=0, v1.x |
| 7 | --dry-run shows output | With --language | status=0, "DRY RUN" |
| 8 | --compact in dry-run | With --compact | status=0, "compact" |
| 9 | --language passed correctly | `--language=javascript` | Output contains language |
| 10 | Multiple languages passed | `--language=go,python` | Output contains languages |
| 11 | --type passed correctly | `--type=cli-tools` | Output contains type |
| 12 | Missing --language fails | No --language | status≠0 |
| 13 | Unknown option fails | `--invalid` | status≠0 |
| 14 | Reports bash environment | Any command | "[INFO] Running via" |

---

## 3. Test Priority Matrix

| Priority | Category | Rationale |
|----------|----------|-----------|
| **P0 - Critical** | Upgrade Safety (2.3) | Data loss prevention is paramount |
| **P0 - Critical** | Migration Tests (2.6) | Prevents data loss during adoption |
| **P0 - Critical** | Adoption Tests (2.7) | Prevents data loss during adoption |
| **P1 - High** | Argument Parsing (2.1) | User-facing errors, first line of defense |
| **P1 - High** | Auto-Detection (2.4) | Upgrade depends on correct detection |
| **P1 - High** | PowerShell Wrapper (2.11) | Windows users depend on this |
| **P2 - Medium** | New File Generation (2.2) | Core functionality, well-tested manually |
| **P2 - Medium** | Deduplication Tests (2.8) | Quality of life feature |
| **P2 - Medium** | Edge Cases (2.10) | Robustness for diverse inputs |
| **P3 - Low** | Template Tests (2.5) | Structural validation, less likely to regress |
| **P3 - Low** | Sync Tests (2.9) | Simple functionality, minimal code paths |

---

## 4. Implementation Order

1. **Setup infrastructure** — `test_helper.bash`
2. **P0: upgrade.bats** — Upgrade safety tests (10 tests)
3. **P0: migrate.bats** — Migration workflow tests (10 tests)
4. **P0: adopt.bats** — Adoption workflow tests (8 tests)
5. **P1: args.bats** — Argument parsing tests (10 tests)
6. **P1: autodetect.bats** — Auto-detection tests (8 tests)
7. **P1: generate-agents.Tests.ps1** — PowerShell wrapper tests (14 tests)
8. **P2: generate.bats** — Generation tests (11 tests)
9. **P2: dedupe.bats** — Deduplication tests (6 tests)
10. **P2: edge-cases.bats** — Edge case tests (6 tests)
11. **P3: templates.bats** — Template tests (8 tests)
12. **P3: sync.bats** — Sync tests (2 tests)

**Total: 108 test cases (94 BATS + 14 Pester)**

---

## 5. Running Tests

### Local (macOS/Linux)

```bash
# Install BATS (Homebrew)
brew install bats-core

# Clone helper libraries
git clone https://github.com/bats-core/bats-support.git test/test_helper/bats-support
git clone https://github.com/bats-core/bats-assert.git test/test_helper/bats-assert

# Run all BATS tests
bats test/*.bats

# Run specific test file
bats test/upgrade.bats

# Run with verbose output
bats --verbose-run test/
```

### Local (PowerShell - any platform)

```powershell
# Install Pester
Install-Module -Name Pester -Force -MinimumVersion 5.0

# Run PowerShell tests
Invoke-Pester test/*.Tests.ps1 -Output Detailed
```

### CI (GitHub Actions)

Tests run automatically on push/PR via `.github/workflows/test.yml`:
- **BATS tests** on Linux, macOS, and Windows (Git Bash)
- **Pester tests** on Linux, macOS, and Windows
- **ShellCheck** linting on Linux

---

## 6. Success Criteria

- [x] All 94 BATS tests pass
- [x] All 14 Pester tests pass
- [x] No test takes longer than 5 seconds
- [x] Upgrade safety tests cover all documented safety guarantees
- [x] CI runs on every push and PR
- [x] Test coverage documented in README badge

